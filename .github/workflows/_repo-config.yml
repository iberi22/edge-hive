# ðŸ”§ Repository Configuration Detection
# This workflow detects repository visibility (public/private) and sets configuration
# Used by other workflows to adjust behavior and resource consumption

name: ðŸ”§ Repo Config Detection

on:
  workflow_call:
    outputs:
      is_public:
        description: "Whether the repository is public"
        value: ${{ jobs.detect.outputs.is_public }}
      enable_schedules:
        description: "Whether to enable scheduled workflows"
        value: ${{ jobs.detect.outputs.enable_schedules }}
      schedule_mode:
        description: "Schedule intensity: aggressive, moderate, conservative"
        value: ${{ jobs.detect.outputs.schedule_mode }}
      is_main_repo:
        description: "Whether this is the main protocol repository"
        value: ${{ jobs.detect.outputs.is_main_repo }}

permissions:
  contents: read

jobs:
  detect:
    name: ðŸ” Detect Repository Configuration
    runs-on: ubuntu-latest
    outputs:
      is_public: ${{ steps.config.outputs.is_public }}
      enable_schedules: ${{ steps.config.outputs.enable_schedules }}
      schedule_mode: ${{ steps.config.outputs.schedule_mode }}
      is_main_repo: ${{ steps.config.outputs.is_main_repo }}

    steps:
      - name: Detect Repository Type
        id: config
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"

          # Detect if public or private
          VISIBILITY=$(gh repo view "$REPO" --json visibility --jq '.visibility' 2>/dev/null || echo "PRIVATE")

          IS_PUBLIC="false"
          if [ "$VISIBILITY" = "PUBLIC" ] || [ "$VISIBILITY" = "public" ]; then
            IS_PUBLIC="true"
          fi

          echo "is_public=$IS_PUBLIC" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Repository visibility: $VISIBILITY (is_public=$IS_PUBLIC)"

          # Detect if this is the main protocol repository
          IS_MAIN="false"
          if [[ "$REPO" == *"Git-Core-Protocol"* ]] || [[ "$REPO" == *"git-core"* ]]; then
            IS_MAIN="true"
          fi
          echo "is_main_repo=$IS_MAIN" >> $GITHUB_OUTPUT
          echo "ðŸ  Is main repository: $IS_MAIN"

          # Determine schedule mode based on repository type
          SCHEDULE_MODE="conservative"
          ENABLE_SCHEDULES="false"

          if [ "$IS_PUBLIC" = "true" ]; then
            # Public repos: Unlimited Actions minutes
            SCHEDULE_MODE="aggressive"
            ENABLE_SCHEDULES="true"
            echo "âœ… PUBLIC repo: Aggressive scheduling enabled (unlimited minutes)"
          elif [ "$IS_MAIN" = "true" ]; then
            # Main repo (even if private): Moderate scheduling
            SCHEDULE_MODE="moderate"
            ENABLE_SCHEDULES="true"
            echo "âš ï¸ MAIN PRIVATE repo: Moderate scheduling (2,000 min/month limit)"
          else
            # Other private repos: Conservative (event-based only)
            SCHEDULE_MODE="conservative"
            ENABLE_SCHEDULES="false"
            echo "ðŸ”’ PRIVATE repo: Conservative mode (event-based triggers only)"
          fi

          echo "enable_schedules=$ENABLE_SCHEDULES" >> $GITHUB_OUTPUT
          echo "schedule_mode=$SCHEDULE_MODE" >> $GITHUB_OUTPUT

          # Summary
          echo "## ðŸ”§ Repository Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`$REPO\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Visibility | $VISIBILITY |" >> $GITHUB_STEP_SUMMARY
          echo "| Is Public | $IS_PUBLIC |" >> $GITHUB_STEP_SUMMARY
          echo "| Is Main Repo | $IS_MAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Enable Schedules | $ENABLE_SCHEDULES |" >> $GITHUB_STEP_SUMMARY
          echo "| Schedule Mode | $SCHEDULE_MODE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Mode Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$SCHEDULE_MODE" = "aggressive" ]; then
            echo "- âœ… All scheduled workflows enabled" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… High-frequency schedules (every 30 min)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Multi-repo monitoring enabled" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCHEDULE_MODE" = "moderate" ]; then
            echo "- âš ï¸ Essential schedules only" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ Reduced frequency (every 6 hours)" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ Single-repo monitoring" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ”’ No scheduled workflows" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ Event-based triggers only" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ Minimal resource usage" >> $GITHUB_STEP_SUMMARY
          fi
