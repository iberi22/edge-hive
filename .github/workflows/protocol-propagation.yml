name: Protocol Propagation

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      update_type:
        description: "Update type"
        required: true
        type: choice
        options:
          - workflows
          - agents
          - scripts
          - full
        default: "workflows"

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  propagate:
    needs: detect-changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo:
          - iberi22/software-factory
          - iberi22/domus-otec
          - iberi22/less-colegio
          - iberi22/synapse-protocol
          - iberi22/gara-g
          - iberi22/AI-Chef
          - iberi22/contratafacil
          - iberi22/bestof-opensorce
          - iberi22/obs-studio-agent
          - iberi22/pocket_cerebro
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Checkout Protocol Repo
        uses: actions/checkout@v4

      - name: Clone Target Repo
        env:
          GH_TOKEN: ${{ secrets.MULTI_REPO_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Configure git to use the token for authentication
          git config --global credential.helper store
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials

          # Clone using https with token
          git clone https://github.com/${{ matrix.repo }}.git target-repo || {
            echo "Cannot access ${{ matrix.repo }}, skipping..."
            exit 0
          }

      - name: Prepare Update
        id: package
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'workflows' }}"
          VERSION="${{ needs.detect-changes.outputs.version }}"

          cd target-repo

          BRANCH_NAME="protocol-update-v${VERSION}"
          git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"

          case "$UPDATE_TYPE" in
            workflows)
              echo "Updating workflows..."
              mkdir -p .github/workflows
              cp -r ../.github/workflows/* .github/workflows/ 2>/dev/null || true
              ;;
            agents)
              echo "Updating agent configs..."
              cp ../AGENTS.md . 2>/dev/null || true
              cp ../.cursorrules . 2>/dev/null || true
              cp -r ../.github/copilot-instructions.md .github/ 2>/dev/null || true
              ;;
            scripts)
              echo "Updating scripts..."
              mkdir -p scripts
              cp -r ../scripts/* scripts/ 2>/dev/null || true
              ;;
            full)
              echo "Full protocol update..."
              cp ../AGENTS.md . 2>/dev/null || true
              cp ../.cursorrules . 2>/dev/null || true
              mkdir -p .github/workflows scripts
              cp -r ../.github/workflows/* .github/workflows/ 2>/dev/null || true
              cp -r ../.github/copilot-instructions.md .github/ 2>/dev/null || true
              cp -r ../scripts/* scripts/ 2>/dev/null || true
              ;;
          esac

          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: update Git-Core Protocol to v${VERSION}"
          fi

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Push Changes
        if: steps.package.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.MULTI_REPO_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          cd target-repo
          git push -u origin ${{ steps.package.outputs.branch }} --force

      - name: Create PR
        if: steps.package.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.MULTI_REPO_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          cd target-repo

          VERSION="${{ needs.detect-changes.outputs.version }}"
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'workflows' }}"
          REPO="${{ matrix.repo }}"

          # Try to create PR without labels first, then add labels if they exist
          gh pr create \
            --title "Git-Core Protocol v${VERSION} Update" \
            --body "Updates from Git-Core Protocol v${VERSION}. Type: ${UPDATE_TYPE}. See: https://github.com/iberi22/Git-Core-Protocol/releases/tag/v${VERSION}" \
            --base main \
            --head ${{ steps.package.outputs.branch }} || echo "PR may already exist"

          # Try to add labels (ignore if they don't exist)
          PR_NUMBER=$(gh pr list --head ${{ steps.package.outputs.branch }} --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$PR_NUMBER" ]; then
            gh pr edit $PR_NUMBER --add-label "dependencies" 2>/dev/null || true
            gh pr edit $PR_NUMBER --add-label "protocol-update" 2>/dev/null || true
          fi
