name: Sync Issues

on:
  push:
    branches: [main]
    paths:
      - '.github/issues/*.md'
  workflow_dispatch:

jobs:
  sync:
    name: Sync Issues to GitHub
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Sync Issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issuesDir = '.github/issues';
            const files = fs.readdirSync(issuesDir).filter(f => f.endsWith('.md'));

            for (const file of files) {
              const content = fs.readFileSync(path.join(issuesDir, file), 'utf8');

              // Parse frontmatter
              const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
              if (!frontmatterMatch) continue;

              const frontmatter = frontmatterMatch[1];
              const body = content.slice(frontmatterMatch[0].length).trim();

              // Extract title
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              if (!titleMatch) continue;
              const title = titleMatch[1];

              // Extract labels
              const labelsMatch = frontmatter.match(/labels:\s*\n((?:\s+-\s+.+\n?)*)/);
              const labels = labelsMatch ?
                labelsMatch[1].split('\n')
                  .map(l => l.replace(/^\s*-\s*/, '').trim())
                  .filter(l => l) : [];

              // Check if issue exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100
              });

              const existing = existingIssues.data.find(i => i.title === title);

              if (existing) {
                console.log(`Updating: ${title}`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existing.number,
                  body: body,
                  labels: labels
                });
              } else {
                console.log(`Creating: ${title}`);
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: labels
                });
              }
            }
