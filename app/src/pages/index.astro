---
import AdminLayout from '../layouts/AdminLayout.astro';
import DashboardView from '../components/dashboard/DashboardView.svelte';
---
<AdminLayout>
  <DashboardView client:load />
</AdminLayout>
	<main class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900">
		<!-- Header -->
		<header class="border-b border-gray-700 bg-gray-900/50 backdrop-blur-sm">
			<div class="container mx-auto px-6 py-4">
				<div class="flex items-center justify-between">
					<div class="flex items-center space-x-3">
						<div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center">
							<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
							</svg>
						</div>
						<div>
							<h1 class="text-2xl font-bold text-white">Edge Hive</h1>
							<p class="text-sm text-gray-400">Distributed Edge Computing</p>
						</div>
					</div>
					<div id="connection-status" class="flex items-center space-x-2 px-4 py-2 bg-gray-800 rounded-lg">
						<div class="w-3 h-3 bg-gray-500 rounded-full animate-pulse"></div>
						<span class="text-sm text-gray-400">Connecting...</span>
					</div>
				</div>
			</div>
		</header>

		<div class="container mx-auto px-6 py-8">
			<!-- Node Status Card -->
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
				<div class="lg:col-span-2 bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
					<h2 class="text-xl font-semibold text-white mb-4">Node Status</h2>
					<div id="node-status-content" class="space-y-4">
						<div class="flex items-center justify-center py-12">
							<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
						</div>
					</div>
				</div>

				<!-- Quick Stats -->
				<div class="space-y-6">
					<div class="bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl p-6 text-white">
						<div class="flex items-center justify-between mb-2">
							<span class="text-sm opacity-90">Edge Functions</span>
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
							</svg>
						</div>
						<div id="functions-count" class="text-4xl font-bold">0</div>
						<div class="text-sm opacity-75 mt-1">deployed</div>
					</div>

					<div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-xl p-6 text-white">
						<div class="flex items-center justify-between mb-2">
							<span class="text-sm opacity-90">Cache Hits</span>
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
							</svg>
						</div>
						<div id="cache-hits" class="text-4xl font-bold">0</div>
						<div class="text-sm opacity-75 mt-1">requests/min</div>
					</div>
				</div>
			</div>

			<!-- Edge Functions List -->
			<div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6 mb-8">
				<div class="flex items-center justify-between mb-6">
					<h2 class="text-xl font-semibold text-white">Edge Functions</h2>
					<button id="create-function-btn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition flex items-center space-x-2">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
						</svg>
						<span>Create Function</span>
					</button>
				</div>
				<div id="functions-list" class="space-y-3">
					<!-- Populated by JS -->
				</div>
			</div>

			<!-- Public URL Section -->
			<div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
				<h2 class="text-xl font-semibold text-white mb-4">Public Access</h2>
				<div id="public-url-content" class="space-y-4">
					<!-- Populated by JS -->
				</div>
			</div>
		</div>

		<!-- Create Function Modal -->
		<div id="create-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
			<div class="bg-gray-800 rounded-xl border border-gray-700 p-6 max-w-2xl w-full mx-4">
				<h3 class="text-2xl font-bold text-white mb-6">Create Edge Function</h3>
				<form id="create-function-form" class="space-y-4">
					<div>
						<label class="block text-sm font-medium text-gray-300 mb-2">Function Name</label>
						<input type="text" id="function-name" required
							class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
							placeholder="my-function">
					</div>
					<div>
						<label class="block text-sm font-medium text-gray-300 mb-2">Rust Code</label>
						<textarea id="function-code" rows="12" required
							class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white font-mono text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
							placeholder="use edge_hive_wasm::prelude::*;

#[wasm_bindgen]
pub fn handle(req: Request) -> Response {
    Response::json(&json!({
        &quot;message&quot;: &quot;Hello from Rust!&quot;
    }))
}"></textarea>
					</div>
					<div class="flex space-x-3">
						<button type="submit" class="flex-1 px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition">
							Deploy Function
						</button>
						<button type="button" id="cancel-modal" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
							Cancel
						</button>
					</div>
				</form>
			</div>
		</div>
	</main>

	<script>
		const API_BASE = 'http://localhost:8080';
		let accessToken = '';

		async function init() {
			try {
				const clientResp = await fetch(`${API_BASE}/mcp/auth/clients`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name: 'ui-dashboard', scopes: ['mcp:read', 'mcp:call'] })
				});
				const client = await clientResp.json();

				const tokenResp = await fetch(`${API_BASE}/mcp/auth/token`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						grant_type: 'client_credentials',
						client_id: client.client_id,
						client_secret: client.client_secret,
						scope: 'mcp:call'
					})
				});
				const tokenData = await tokenResp.json();
				accessToken = tokenData.access_token;

				updateConnectionStatus(true);
				await loadNodeStatus();
				await loadEdgeFunctions();
				await loadPublicURL();

				setInterval(async () => {
					await loadNodeStatus();
					await loadEdgeFunctions();
				}, 5000);

			} catch (err) {
				console.error('Init error:', err);
				updateConnectionStatus(false);
			}
		}

		function updateConnectionStatus(connected) {
			const statusEl = document.getElementById('connection-status');
			if (connected) {
				statusEl.innerHTML = `
					<div class="w-3 h-3 bg-green-500 rounded-full"></div>
					<span class="text-sm text-green-400">Connected</span>
				`;
			} else {
				statusEl.innerHTML = `
					<div class="w-3 h-3 bg-red-500 rounded-full"></div>
					<span class="text-sm text-red-400">Disconnected</span>
				`;
			}
		}

		async function mcpToolCall(toolName, args = {}) {
			const response = await fetch(`${API_BASE}/mcp/tools/call`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${accessToken}`
				},
				body: JSON.stringify({
					jsonrpc: '2.0',
					id: 1,
					method: 'tools/call',
					params: { name: toolName, arguments: args }
				})
			});
			const data = await response.json();
			return data.content?.[0]?.text || '';
		}

		async function loadNodeStatus() {
			try {
				const statusText = await mcpToolCall('get_status');
				const lines = statusText.split('\n');

				const statusHTML = `
					<div class="grid grid-cols-2 gap-4">
						<div class="bg-gray-900/50 rounded-lg p-4">
							<div class="text-sm text-gray-400 mb-1">Node ID</div>
							<div class="text-lg font-semibold text-white">${lines[0]?.split(': ')[1] || 'Unknown'}</div>
						</div>
						<div class="bg-gray-900/50 rounded-lg p-4">
							<div class="text-sm text-gray-400 mb-1">Status</div>
							<div class="text-lg font-semibold text-green-400">${lines[1]?.split(': ')[1] || 'Unknown'}</div>
						</div>
						<div class="bg-gray-900/50 rounded-lg p-4 col-span-2">
							<div class="text-sm text-gray-400 mb-1">Tunnel</div>
							<div class="text-lg font-semibold text-cyan-400">${lines[2]?.split(': ')[1] || 'Unknown'}</div>
						</div>
					</div>
				`;

				document.getElementById('node-status-content').innerHTML = statusHTML;
			} catch (err) {
				console.error('Load status error:', err);
			}
		}

		async function loadEdgeFunctions() {
			try {
				const listText = await mcpToolCall('edge_function_list');
				const data = JSON.parse(listText);
				const functions = data.functions || [];

				document.getElementById('functions-count').textContent = functions.length;

				if (functions.length === 0) {
					document.getElementById('functions-list').innerHTML = `
						<div class="text-center py-12 text-gray-400">
							<svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
							</svg>
							<p>No edge functions deployed yet</p>
						</div>
					`;
				} else {
					const functionsHTML = functions.map(fn => `
						<div class="flex items-center justify-between bg-gray-900/50 rounded-lg p-4 hover:bg-gray-900/70 transition">
							<div class="flex items-center space-x-4">
								<div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-lg flex items-center justify-center">
									<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
									</svg>
								</div>
								<div>
									<div class="text-white font-semibold">${fn}</div>
									<div class="text-sm text-gray-400">WASM Runtime</div>
								</div>
							</div>
							<button onclick="executeFunction('${fn}')" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition text-sm">
								Execute
							</button>
						</div>
					`).join('');

					document.getElementById('functions-list').innerHTML = functionsHTML;
				}
			} catch (err) {
				console.error('Load functions error:', err);
			}
		}

		async function loadPublicURL() {
			const urlContent = `
				<div class="bg-gray-900/50 rounded-lg p-4">
					<div class="flex items-center justify-between mb-2">
						<span class="text-sm text-gray-400">Public Endpoint</span>
						<span class="px-2 py-1 bg-green-900/50 text-green-400 text-xs rounded">Active</span>
					</div>
					<div class="flex items-center space-x-2">
						<code class="flex-1 px-3 py-2 bg-gray-950 rounded text-cyan-400 text-sm">https://edge-hive.your-domain.com</code>
						<button onclick="copyURL()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
							<svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
							</svg>
						</button>
					</div>
				</div>
			`;
			document.getElementById('public-url-content').innerHTML = urlContent;
		}

		window.executeFunction = async function(name) {
			try {
				const response = await fetch(`${API_BASE}/api/v1/edge/${name}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ test: true })
				});
				const result = await response.json();
				alert(`Result: ${JSON.stringify(result, null, 2)}`);
			} catch (err) {
				alert(`Error: ${err.message}`);
			}
		};

		window.copyURL = function() {
			navigator.clipboard.writeText('https://edge-hive.your-domain.com');
			alert('URL copied to clipboard!');
		};

		document.getElementById('create-function-btn')?.addEventListener('click', () => {
			document.getElementById('create-modal').classList.remove('hidden');
		});

		document.getElementById('cancel-modal')?.addEventListener('click', () => {
			document.getElementById('create-modal').classList.add('hidden');
		});

		document.getElementById('create-function-form')?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const name = document.getElementById('function-name').value;
			const code = document.getElementById('function-code').value;

			try {
				await mcpToolCall('edge_function_create', {
					name,
					template: { rust_code: code }
				});

				document.getElementById('create-modal').classList.add('hidden');
				await loadEdgeFunctions();
				alert('Function deployed successfully!');
			} catch (err) {
				alert(`Error: ${err.message}`);
			}
		});

		init();
	</script>
</Layout>

